<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Generate Calendar in pdf</title>
    <link rel="icon" href="/calendar-favicon.svg" type="image/x-icon">
    <!-- Bootstrap CSS (si aún no lo tienes) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css" />

    <!-- jQuery (requerido) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS (si aún no lo tienes) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>

    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="card">
        <h1>Generate Calendar in pdf</h1>
        <form id="form-id" class="form" action="/generate" method="POST">
            <div class="form-group">
                <label for="input-year">Calendar year:</label>
                <input id="input-year" class="form-control input-year" type="text" name="year" required
                    autocomplete="off" />
            </div>
            <button type="submit" class="btn-submit">Generate PDF</button>
        </form>
    </div>

    <div class="card">
        <h2>Add Events</h2>
        <form>
            <div class="form-group">
                <label for="input-date">Select a day:</label>
                <input id="input-date" class="form-control input-date" type="text" name="date" autocomplete="off" />
            </div>
            <div class="form-group padding-0 align-items-end">
                <textarea id="name-event" class="form-control textarea" rows="2" type="text"></textarea>
                <button id="btn-submit-add-event" type="button" class="btn-submit-add-event">Add event</button>
            </div>
            <ul id="event-list" class="event-list"></ul>
        </form>
    </div>

</body>

<script defer>
    const events = [];

    // addEventListener from add event
    document.querySelector('#btn-submit-add-event').addEventListener('click', () => {
        const rawDate = document.getElementById('input-date').value;
        const nameEvent = document.getElementById('name-event').value.trim();

        if (!rawDate || !nameEvent) {
            alert("Please, select a date and write a name to the event.");
            return;
        }

        const [day, month, year] = rawDate.split('/');
        const formattedEvent = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${nameEvent}`;

        events.push(formattedEvent);
        const list = document.getElementById('event-list');
        console.log('list', list);

        const itemList = document.createElement('li');
        itemList.classList.add('event-item');

        const spanEventDate = document.createElement('span');
        spanEventDate.classList.add('event-date');
        spanEventDate.textContent = `${day.padStart(2, "0")}/${month.padStart(2, "0")}`;

        const spanEventName = document.createElement('span');
        spanEventName.classList.add('event-name');
        spanEventName.textContent = nameEvent;

        itemList.appendChild(spanEventDate);
        itemList.appendChild(spanEventName);

        list.appendChild(itemList);

        document.getElementById('input-date').value = '';
        document.getElementById('name-event').value = '';
    });

    // addEventListener from generate calendar
    document.querySelector(".form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const year = document.getElementById("input-year").value;

        try {
            const response = await fetch("/generate", {
                method: "POST",
                body: JSON.stringify({ year, events }),
                headers: {
                    "Content-Type": "application/json",
                },
            });

            if (!response.ok) {
                throw new Error("Error al generar el PDF");
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Calendar_${year}.pdf`;
            a.click();
            URL.revokeObjectURL(url);

        } catch (error) {
            console.error("/generate:", error);
        }
    });
</script>

<script defer>
    const yearPicker = $('#input-year');
    const datePicker = $('#input-date');

    yearPicker.datepicker({
        format: "yyyy",
        viewMode: "years",
        minViewMode: "years",
        autoclose: true,
        orientation: "bottom auto"
    });
    const actualYear = new Date();
    yearPicker.datepicker('update', actualYear);


    const initDatePicker = (selectedYear) => {
        const startDate = new Date(`${selectedYear}-01-01`);
        const endDate = new Date(`${selectedYear}-12-31`);

        datePicker.datepicker('destroy');
        datePicker.datepicker({
            format: "dd/mm",
            startView: 1,
            minViewMode: 0,
            autoclose: true,
            orientation: "bottom auto",
            todayHighlight: true
        });
    };


    initDatePicker(actualYear.getFullYear());

    yearPicker.on('changeDate', function (e) {
        initDatePicker(e.date.getFullYear());
    });
</script>

</html>